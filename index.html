<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="media\Y Locked.png">

  <title>Egypt Market Research</title>
	
  <!-- jQuery-->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

  <!-- Leaflet (CSS and JS) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/js/fontawesome.min.js"></script>

  <!-- leaflet-providers-->
  <script src="https://unpkg.com/leaflet-providers@1.10.2/leaflet-providers.js"></script>
  
  <!-- Leaflet.awesome-markers v2.0.4, manually updated to svg to allow hex and material icons -->
  <link rel="stylesheet" type="text/css" href="scripts/Leaflet.awesome-markers/dist/leaflet.awesome-markers.css">
  <script type="text/javascript" src="scripts/Leaflet.awesome-markers/dist/leaflet.awesome-markers.js"></script>

  <!-- Leaflet Markercluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
  <script type="text/javascript" src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <!-- Leaflet Markercluster layer support -->
  <script src="https://unpkg.com/leaflet.markercluster.layersupport@2.0.1/dist/leaflet.markercluster.layersupport.js"></script>

  <!-- Leaflet control geocoder -->
  <link rel="stylesheet" href="leaflet-search-master\dist\leaflet-search.src.css" />
  <script src="Search.js"></script>
  <script src="leaflet-search-master\dist\leaflet-search.src.js"></script>

  <!-- Leaflet Ruler-->
  <link rel="stylesheet" href="leaflet-ruler-master\src\leaflet-ruler.css" />
  <script src="leaflet-ruler-master\src\leaflet-ruler.js"></script> 

  <!-- Locate Control -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.72.0/L.Control.Locate.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.72.0/L.Control.Locate.min.js"></script>

  <!-- jQuery-CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.11/jquery.csv.min.js"></script>

  <!-- Custom style sheet -->
  <link rel="stylesheet" type="text/css" href="style.css">

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css" />

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>

<body>
	<script language="javascript"></script>
	<div class="loader">Loading...</div>
	<div id="map"></div>
	<button id="container" class="btn">Prices Analysis</button>
	<button id="container1" class="btn" onclick="masterplan()">Master Plan</button>
	<button id="container2" class="btn" onclick="threshold()">Thresholds KM</button>
  
  <table id="maptable" class="display"></table>

	
<script type="text/javascript">
	var map = L.map('map', {
		attributionControl: false,
		zoomControl: false,
		scrollWheelZoom: true,
		tap: false
	}).setView([30.02,31.55], 11); // default center is overridden by Google Sheet options and points
    var OpenStreetMap_Mapnik = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
	maxZoom: 19
});
    var TopPlusOpen_Grey = L.tileLayer('http://sgx.geodatenzentrum.de/wmts_topplus_open/tile/1.0.0/web_grau/default/WEBMERCATOR/{z}/{y}/{x}.png', {
      maxZoom: 19
    });
//Leaflet layer control
    var baseMaps = {
      'Details Map': TopPlusOpen_Grey,
      'Colored Map': OpenStreetMap_Mapnik,
    }
    var overlayMaps = {
  'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19
})
    }

	//Json data search
const searchLayer = L.geoJSON(Search, {
  onEachFeature: function(feature, layer) {
    layer.bindPopup(feature.properties.Project);
  }
});

//ruler
var options = {
    position: 'bottomright',
    lengthUnit: {
        display: 'km',
        label: 'Distance:',
        decimal: 2,
    },
};

  let isDrawing = false;
  let isDrawingMode = false;
  let drawnLines = [];
  let currentLine = [];
  const drawLayer = L.layerGroup().addTo(map);

  function redrawLines() {
    drawLayer.clearLayers();
    for (const line of drawnLines) {
      L.polyline(line, { color: 'red', weight: 3 }).addTo(drawLayer);
    }
  }
  // Ø²Ø± ESC Ù„Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø³Ù… ÙÙ‚Ø·
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && isDrawingMode) {
      isDrawingMode = false;
      document.querySelector('.leaflet-control-draw').style.backgroundColor = "#2e4053";
      map.dragging.enable();
    }
  });
  // Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø±Ø³Ù…
  map.on("mousedown", (e) => {
    if (!isDrawingMode) return;
    isDrawing = true;
    currentLine = [e.latlng];
  });
  // Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø³ØªÙ…Ø±
  map.on("mousemove", (e) => {
    if (!isDrawingMode || !isDrawing) return;
    currentLine.push(e.latlng);
    redrawLines();
    L.polyline(currentLine, { color: 'red', weight: 3 }).addTo(drawLayer);
  });
  // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨
  map.on("mouseup", () => {
    if (!isDrawingMode || !isDrawing) return;
    isDrawing = false;
    drawnLines.push([...currentLine]);
    currentLine = [];
    redrawLines();
  });
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø£Ùˆ ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  map.on("moveend zoomend", () => {
    redrawLines();
  });
</script>

  
<script>
	var myImageLayer;
	function masterplan() {
		var imageUrl1 = 'media/layout.png';
		var imageBounds1 = [[29.994293, 31.574531], [29.933195, 31.521640], [29.921658, 31.583310]];

		if (myImageLayer) {
			map.removeLayer(myImageLayer);
			myImageLayer = null;
		} else {
			myImageLayer = L.layerGroup([
				L.imageOverlay(imageUrl1, imageBounds1)
			]);
			myImageLayer.addTo(map);
		}
	}
</script>

<script>
  var marker0, circle1, marker1, circle2, marker2, circle3, marker3;
  var circlesVisible = false;
  var markersVisible = false;
  
  function threshold() {
      if (circlesVisible && markersVisible) {
          // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
          map.removeLayer(circle1);
          map.removeLayer(circle2);
          map.removeLayer(circle3);
          map.removeLayer(marker0);
          map.removeLayer(marker1);
          map.removeLayer(marker2);
          map.removeLayer(marker3);

          circlesVisible = false;
          markersVisible = false;
      } else {
          // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
          function getPointOnCircle(center, radiusMeters) {
    const lat = center[0];
    const lng = center[1];
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØªØ± Ù„Ø¯Ø±Ø¬Ø§Øª (ØªÙ‚Ø±ÙŠØ¨ ÙƒØ§ÙÙŠ Ù„Ù„Ø¹Ø±Ø¶)
    const offsetLng = radiusMeters / (111320 * Math.cos(lat * Math.PI / 180));
    return [lat, lng + offsetLng];
}

var targetPointStr = getSetting('_Target');
var center = [29.97, 31.33];

if (targetPointStr) {
    var parts = targetPointStr.split(',');
    if (parts.length === 2) {
        center = [
            parseFloat(parts[0].trim()),
            parseFloat(parts[1].trim())
        ];
    }
}

  var redIcon = L.icon({
    iconUrl: 'media/home icon.png', // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø±Ø§Ø¨Ø· Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ù…Ø±Ø§Ø¡
    iconSize: [26, 32], // Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    iconAnchor: [12, 41], // Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙŠ ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù€ Marker
    popupAnchor: [1, -34], // Ù…ÙˆÙ‚Ø¹ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨Ø§Ù„ÙˆÙ† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚
    shadowSize: [41, 41] // Ø­Ø¬Ù… Ø§Ù„Ø¸Ù„
  });
marker0 = L.marker(getPointOnCircle(center, 0), { icon: redIcon })
.bindTooltip("<b>" + getSetting('_TargetN') ).addTo(map);
	// ÙˆØ¸ÙŠÙØ© Ù„Ø¥Ø®ÙØ§Ø¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙƒØ¨ÙŠØ±
  map.on('zoomend', function () {
    if (!markersVisible) return; // ğŸ”´ Ø£Ù‡Ù… Ø³Ø·Ø±

    var currentZoom = map.getZoom();
    if (currentZoom < 9) {
        map.removeLayer(marker0);
    } else {
        map.addLayer(marker0);
    }
});

circle1 = L.circle(center, {
    color: 'red',
    fillOpacity: 0.02,
    radius: 5000
}).addTo(map);

marker1 = L.marker(getPointOnCircle(center, 3850), {
    icon: L.divIcon({
        className: 'circle-label',
        html: '5K'
    })
}).addTo(map);

circle2 = L.circle(center, {
    color: 'red',
    fillOpacity: 0.02,
    radius: 10000
}).addTo(map);

marker2 = L.marker(getPointOnCircle(center, 8180), {
    icon: L.divIcon({
        className: 'circle-label',
        html: '10K'
    })
}).addTo(map);

circle3 = L.circle(center, {
    color: 'red',
    fillOpacity: 0.02,
    radius: 15000
}).addTo(map);

marker3 = L.marker(getPointOnCircle(center, 13155), {
    icon: L.divIcon({
        className: 'circle-label',
        html: '15K'
    })
}).addTo(map);
  
// Ø¯Ø§Ù„Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø´ÙØ§ÙÙŠØ© (Ù„Ø¥Ø¹Ø·Ø§Ø¡ ØªØ£Ø«ÙŠØ± Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ© ÙÙ‚Ø·)
          function animateCircle(circle, marker) {
              var opacity = 1;
              var increasing = false;
  
              setInterval(function() {
                  if (increasing) {
                      opacity += 0.1;
                      if (opacity >= 1) increasing = false;
                  } else {
                      opacity -= 0.1;
                      if (opacity <= 0) increasing = true;
                  }
                  // ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø­Ø§ÙØ©
                  circle.setStyle({ opacity: opacity });
                  // ÙˆÙ…ÙŠØ¶ Ø§Ù„Ù…Ø§Ø±ÙƒØ± (Label)
        if (marker) {
            marker.setOpacity(opacity);
        }
              }, 50);
          }
          // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
          animateCircle(circle1, marker1);
          animateCircle(circle2, marker2);
          animateCircle(circle3, marker3);
          circlesVisible = true;
          markersVisible = true;
      }
  }
  </script>
	
  <script type="text/javascript" src="./google-doc-url.js"></script>
  <script type="text/javascript" src="./scripts/constants.js"></script>
  <script type="text/javascript" src="./scripts/palette.js"></script>
  <script type="text/javascript" src="./scripts/polylabel.js"></script>
  <script type="text/javascript" src="./scripts/map.js"></script>

</body>
</html>
